@using Lumos.Data.Enums;
@using Newtonsoft.Json;

@{
    Layout = null;
}

@model Lumos.Application.Dtos.Management.UsersDto;

<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <p style="font-size: 1.1em!important;margin: 0; font-weight: bold;">Editar Usuário</p>
</div>

<div class="modal-body">
    <form id="editUser" style="margin: auto!important">
        <input type="hidden" name="TenantId" value="@Model.TenantId" />
        <input type="hidden" name="Id" id="Id" value="@Model.Id" />

        <div class="row">
            <div class="form-group col-md-6">
                <label for="Email" class="input-label">E-mail<span class="input-label-required"></span></label>
                <input type="text" class="form-control" name="Email" id="Email" placeholder="" autocomplete="email" value="@Model.Email">
            </div>

            <div class="form-group col-md-6">
                <label for="FullName" class="input-label">Nome Completo<span class="input-label-required"></span></label>
                <input type="text" class="form-control" name="FullName" id="FullName" placeholder="" autocomplete="fullName" value="@Model.FullName">
            </div>
        </div>

        <div class="row">
            <div class="form-group col-md-6">
                <label for="Password" class="input-label">Senha<span class="input-label-required"></span></label>
                <div class="input-group">
                    <input type="password" class="form-control" name="Password" id="Password" placeholder="" autocomplete="password" value="@Model.DecryptedPassword">
                    <span class="input-group-addon toggle-password" style="cursor: pointer;">
                        <i class="fa fa-eye"></i>
                    </span>
                </div>
            </div>

            <div class="form-group col-md-6">
                <label for="Cpf" class="input-label">CPF<span class="input-label-required"></span></label>
                <input type="text" class="form-control" name="Cpf" id="Cpf" placeholder="" value="@Model.Cpf">
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-12">
                <label for="SelectedUnits" class="input-label">Selecionar Unidades<span class="input-label-required"></span></label>
                <select id="SelectedUnits" class="form-control" multiple required></select>
            </div>
        </div>
        <hr style="margin: 10px 0!important" />

        <div class="row">
            <div class="col-md-12" style="display: flex; justify-content: flex-end; gap: 20px;">
                <button class="btn btn-success save float-right" type="submit" id="submitButton">Atualizar Cadastro</button>
            </div>
        </div>
    </form>
</div>

<script src="~/js/site.js" asp-append-version="true"></script>


<script>
    $('.toggle-password').click(function () {
        var $input = $(this).closest('.input-group').find('input');
        var type = $input.attr('type') === 'password' ? 'text' : 'password';
        $input.attr('type', type);
        $(this).find('i').toggleClass('fa-eye fa-eye-slash');
    });

    $('#UserEditModal').on('shown.bs.modal', function () {
        var unitsJson = '@Html.Raw(JsonConvert.SerializeObject(Model.Units, new JsonSerializerSettings { ReferenceLoopHandling = ReferenceLoopHandling.Ignore }))';
        var units = JSON.parse(unitsJson);

        console.log(" - ", units);
        AjaxGetAllDefault("Units", function (data) {
            if (data && data.length > 0) {
                console.log("data: ", data);
                var allUnits = data.filter(function (unit) {
                    return unit.tenantId === parseInt($('input[name="TenantId"]').val());
                });


                console.log("allUnits: ", allUnits);

                var $selectedUnits = $("#SelectedUnits");
                $selectedUnits.empty();

                allUnits.forEach(function (unit) {
                    var isSelected = units.some(function (selectedUnit) {
                        console.log("validado: " + selectedUnit.Name + " - " + selectedUnit.Id === unit.id);
                        return selectedUnit.Id === unit.id;
                    });


                    var option = $("<option>", {
                        value: unit.id,
                        text: unit.name,
                        selected: isSelected
                    });
                    $selectedUnits.append(option);
                });

                InitializeSelect2("#SelectedUnits", "Selecione as Unidades");
            }
        });
    });


    $("#editUser").on('submit', function (e) {
        e.preventDefault();
        var selectedUnits = $("#SelectedUnits").val();

        var id = $('#UnitId').val();
        var formData = new FormData($('#editUser')[0]);
        formData.append('SerializedUnitsList', JSON.stringify(selectedUnits));


        var url = `/Users/Update/${id}`;

        AjaxUpdateDefault("#submitButton", url, formData, "#UserEditModal");
    })
</script>
